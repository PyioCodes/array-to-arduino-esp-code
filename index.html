<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OLED All-in-One Generator</title>
    <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0c0c0c; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: #161616; padding: 30px; border-radius: 12px; border: 1px solid #333; }
        h2 { color: #00d4ff; border-bottom: 2px solid #00d4ff; padding-bottom: 10px; margin-top: 0; text-transform: uppercase; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px; }
        .panel { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px; color: #00d4ff; }
        textarea { width: 100%; height: 120px; background: #000; color: #0f0; border: 1px solid #444; padding: 10px; font-family: monospace; border-radius: 5px; box-sizing: border-box; }
        select, input, button { width: 100%; padding: 12px; margin-top: 10px; background: #333; color: #fff; border: 1px solid #444; border-radius: 6px; box-sizing: border-box; }
        button { background: #00d4ff; color: #000; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        button:hover { background: #0099bb; transform: translateY(-2px); }
        .copy-btn { background: #ff9d00; margin-top: 10px; }
        #final-code { height: 400px; color: #ff9d00; margin-top: 15px; }
        .footer { margin-top: 25px; text-align: center; font-size: 14px; background: #222; padding: 15px; border-radius: 8px; }
        a { color: #00d4ff; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>OLED Pro Master Tool</h2>
    
    <div class="main-grid">
        <div class="panel">
            <label>OPTION A: PASTE EXISTING ARRAY</label>
            <textarea id="array-input" placeholder="Paste const unsigned char myBitmap [] PROGMEM = {...}; here"></textarea>
            <button onclick="generateFromStatic()">GENERATE FROM STATIC</button>
        </div>

        <div class="panel">
            <label>OPTION B: UPLOAD GIF FILE</label>
            <input type="file" id="gif-file" accept="image/gif">
            <select id="scale-mode">
                <option value="contain">Keep Proportions (Letterbox)</option>
                <option value="stretch">Stretch to Fill Screen</option>
            </select>
            <button onclick="processGif()">CONVERT GIF TO CODE</button>
        </div>
    </div>

    <div class="panel">
        <label>GLOBAL SETTINGS</label>
        <div style="display: flex; gap: 10px;">
            <select id="platform">
                <option value="esp32">ESP32 (GPIO 21/22)</option>
                <option value="arduino">Arduino (A4/A5)</option>
            </select>
            <select id="resolution">
                <option value="128x64">128 x 64</option>
                <option value="128x32">128 x 32</option>
            </select>
        </div>
        
        <textarea id="final-code" readonly placeholder="Your C++ code will appear here..."></textarea>
        <button class="copy-btn" onclick="copyToClipboard()">COPY TO CLIPBOARD</button>
    </div>

    <div class="footer">
        Manual Conversion: <a href="https://javl.github.io/image2cpp/" target="_blank">image2cpp</a>
    </div>
</div>

<canvas id="temp-canvas" style="display:none;"></canvas>

<script>
const output = document.getElementById('final-code');

function copyToClipboard() {
    output.select();
    document.execCommand('copy');
    alert("Code copied to clipboard!");
}

function getBaseConfig() {
    const res = document.getElementById('resolution').value.split('x');
    return {
        width: parseInt(res[0]),
        height: parseInt(res[1]),
        platform: document.getElementById('platform').value,
        wire: document.getElementById('platform').value === 'esp32' ? "Wire.begin(21, 22);" : "Wire.begin();"
    };
}

// FUNCTION 1: STATIC GENERATOR (YOUR ORIGINAL REQUEST)
function generateFromStatic() {
    const data = document.getElementById('array-input').value.trim();
    const config = getBaseConfig();
    if(!data.includes('0x')) return alert("Paste valid array!");

    output.value = `#include <Wire.h>\n#include <Adafruit_GFX.h>\n#include <Adafruit_SSD1306.h>\n\n#define SCREEN_WIDTH ${config.width}\n#define SCREEN_HEIGHT ${config.height}\n#define SCREEN_ADDRESS 0x3C\n\nAdafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);\n\n${data}\n\nvoid setup() {\n  ${config.wire}\n  display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS);\n  display.clearDisplay();\n  display.drawBitmap(0, 0, myBitmap, ${config.width}, ${config.height}, 1);\n  display.display();\n}\n\nvoid loop() {}`;
}

// FUNCTION 2: GIF PROCESSOR
async function processGif() {
    const file = document.getElementById('gif-file').files[0];
    if (!file) return alert("Select a GIF!");
    const config = getBaseConfig();
    const scale = document.getElementById('scale-mode').value;

    const reader = new FileReader();
    reader.readAsArrayBuffer(file);
    reader.onload = function() {
        const gif = new omggif.GifReader(new Uint8Array(reader.result));
        let arrays = "";
        let frameNames = [];
        const canvas = document.getElementById('temp-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = config.width; canvas.height = config.height;

        for (let i = 0; i < gif.numFrames(); i++) {
            const frameData = new Uint8ClampedArray(gif.width * gif.height * 4);
            gif.decodeAndBlitFrameRGBA(i, frameData);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = gif.width; tempCanvas.height = gif.height;
            tempCanvas.getContext('2d').putImageData(new ImageData(frameData, gif.width, gif.height), 0, 0);

            ctx.fillStyle = "black"; ctx.fillRect(0, 0, config.width, config.height);
            if (scale === 'stretch') ctx.drawImage(tempCanvas, 0, 0, config.width, config.height);
            else {
                const r = Math.min(config.width / gif.width, config.height / gif.height);
                ctx.drawImage(tempCanvas, (config.width - gif.width*r)/2, (config.height - gif.height*r)/2, gif.width*r, gif.height*r);
            }

            const img = ctx.getImageData(0, 0, config.width, config.height).data;
            let bytes = [];
            for (let y = 0; y < config.height; y++) {
                for (let x = 0; x < config.width; x += 8) {
                    let b = 0;
                    for (let bit = 0; bit < 8; bit++) {
                        if ((img[((y * config.width) + (x + bit)) * 4] + img[((y * config.width) + (x + bit)) * 4 + 1] + img[((y * config.width) + (x + bit)) * 4 + 2]) / 3 > 128) b |= (1 << (7 - bit));
                    }
                    bytes.push('0x' + b.toString(16).padStart(2, '0'));
                }
            }
            arrays += `const unsigned char frame${i} [] PROGMEM = {\n  ${bytes.join(', ')}\n};\n\n`;
            frameNames.push(`frame${i}`);
        }

        output.value = `#include <Wire.h>\n#include <Adafruit_GFX.h>\n#include <Adafruit_SSD1306.h>\n\n#define W ${config.width}\n#define H ${config.height}\nAdafruit_SSD1306 display(W, H, &Wire, -1);\n\n${arrays}\nconst unsigned char* frames[] = {${frameNames.join(',')}};\n\nvoid setup() {\n  ${config.wire}\n  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);\n}\n\nvoid loop() {\n  for(int i=0; i<${gif.numFrames()}; i++) {\n    display.clearDisplay();\n    display.drawBitmap(0, 0, frames[i], W, H, 1);\n    display.display();\n    delay(50);\n  }\n}`;
    };
}
</script>
</body>
</html>
