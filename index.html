<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OLED ANIMATION MASTER + PROGRESS</title>
    <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #000; color: #00ff00; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; border: 2px solid #00ff00; padding: 20px; background: #050505; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { border: 1px solid #444; padding: 15px; background: #111; }
        textarea { width: 100%; height: 120px; background: #000; color: #0f0; border: 1px solid #00ff00; padding: 5px; font-size: 11px; }
        select, input, button { width: 100%; padding: 10px; margin-top: 10px; background: #222; color: #fff; border: 1px solid #555; cursor: pointer; }
        button { background: #00ff00; color: #000; font-weight: bold; border: none; font-size: 14px; }
        button:hover { background: #fff; box-shadow: 0 0 10px #00ff00; }
        #final-code { height: 400px; color: #00d4ff; border-color: #00d4ff; }
        
        /* Progress Bar Styles */
        #progress-container { width: 100%; background: #333; height: 20px; margin-top: 15px; display: none; border-radius: 10px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #00ff00; transition: width 0.1s; }
        #status-text { text-align: center; font-size: 12px; margin-top: 5px; color: #00ff00; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">OLED ANIMATION MASTER</h2>
    
    <div class="row">
        <div class="panel">
            <label>OPTION A: STATIC BITMAP (ARRAY)</label>
            <textarea id="static-input" placeholder="Paste your myBitmap array here..."></textarea>
            <button onclick="buildStatic()">GENERATE STATIC SKETCH</button>
        </div>
        
        <div class="panel">
            <label>OPTION B: GIF FILE (ALL FRAMES)</label>
            <input type="file" id="gif-input" accept="image/gif">
            <input type="number" id="frame-delay" value="50" placeholder="Delay (ms)">
            
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
            <div id="status-text"></div>
            
            <button id="gif-btn" onclick="buildAnimation()">GENERATE ANIMATED SKETCH</button>
        </div>
    </div>

    <div class="panel">
        <label>GLOBAL SYSTEM CONFIG</label>
        <div style="display:flex; gap:10px;">
            <select id="platform">
                <option value="esp32">ESP32 (GPIO 21/22)</option>
                <option value="arduino">ARDUINO (A4/A5)</option>
            </select>
            <select id="res">
                <option value="128x64">128x64</option>
                <option value="128x32">128x32</option>
            </select>
        </div>
        <textarea id="final-code" readonly placeholder="C++ Code Output..."></textarea>
        <button onclick="copyCode()" style="background:#00d4ff;">COPY TO CLIPBOARD</button>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const output = document.getElementById('final-code');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const pBar = document.getElementById('progress-bar');
const pCont = document.getElementById('progress-container');
const sText = document.getElementById('status-text');

function copyCode() {
    output.select();
    document.execCommand('copy');
    alert("Code Copied!");
}

function getSettings() {
    const r = document.getElementById('res').value.split('x');
    return {
        w: parseInt(r[0]),
        h: parseInt(r[1]),
        wire: document.getElementById('platform').value === 'esp32' ? "Wire.begin(21, 22);" : "Wire.begin();"
    };
}

function buildStatic() {
    const s = getSettings();
    const arr = document.getElementById('static-input').value.trim();
    if(!arr.includes('0x')) return alert("Error: Invalid Array");
    output.value = `#include <Wire.h>\n#include <Adafruit_GFX.h>\n#include <Adafruit_SSD1306.h>\n\n#define W ${s.w}\n#define H ${s.h}\nAdafruit_SSD1306 display(W, H, &Wire, -1);\n\n${arr}\n\nvoid setup() {\n  ${s.wire}\n  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);\n  display.clearDisplay();\n  display.drawBitmap(0, 0, myBitmap, W, H, 1);\n  display.display();\n}\n\nvoid loop() {}`;
}

async function buildAnimation() {
    const file = document.getElementById('gif-input').files[0];
    if(!file) return alert("Select a GIF!");

    pCont.style.display = "block";
    sText.innerText = "Initializing GIF data...";
    
    const s = getSettings();
    const delayVal = document.getElementById('frame-delay').value;
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        const gifData = new Uint8Array(e.target.result);
        const gifReader = new omggif.GifReader(gifData);
        const numFrames = gifReader.numFrames();
        
        let allArrays = "";
        let frameNames = [];
        canvas.width = s.w;
        canvas.height = s.h;

        for (let i = 0; i < numFrames; i++) {
            // Processing Frame
            const framePixels = new Uint8ClampedArray(gifReader.width * gifReader.height * 4);
            gifReader.decodeAndBlitFrameRGBA(i, framePixels);

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = gifReader.width;
            tempCanvas.height = gifReader.height;
            tempCanvas.getContext('2d').putImageData(new ImageData(framePixels, gifReader.width, gifReader.height), 0, 0);

            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, s.w, s.h);
            ctx.drawImage(tempCanvas, 0, 0, s.w, s.h);

            const imgData = ctx.getImageData(0, 0, s.w, s.h).data;
            let bytes = [];
            for (let y = 0; y < s.h; y++) {
                for (let x = 0; x < s.w; x += 8) {
                    let b = 0;
                    for (let k = 0; k < 8; k++) {
                        const idx = ((y * s.w) + (x + k)) * 4;
                        if ((imgData[idx] + imgData[idx+1] + imgData[idx+2]) / 3 > 128) b |= (1 << (7 - k));
                    }
                    bytes.push('0x' + b.toString(16).padStart(2, '0'));
                }
            }
            allArrays += `const unsigned char frame${i} [] PROGMEM = {${bytes.join(',')}};\n`;
            frameNames.push(`frame${i}`);

            // Update UI
            let percent = Math.round(((i + 1) / numFrames) * 100);
            pBar.style.width = percent + "%";
            sText.innerText = `Processing Frame: ${i + 1} / ${numFrames} (${percent}%)`;
            
            // Artificial pause to allow UI thread to update
            if (i % 5 === 0) await new Promise(r => setTimeout(r, 1));
        }

        output.value = `#include <Wire.h>\n#include <Adafruit_GFX.h>\n#include <Adafruit_SSD1306.h>\n\n#define W ${s.w}\n#define H ${s.h}\nAdafruit_SSD1306 display(W, H, &Wire, -1);\n\n${allArrays}\nconst unsigned char* frames[] = {${frameNames.join(',')}};\n\nvoid setup() {\n  ${s.wire}\n  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);\n}\n\nvoid loop() {\n  for(int i = 0; i < ${numFrames}; i++) {\n    display.clearDisplay();\n    display.drawBitmap(0, 0, frames[i], W, H, 1);\n    display.display();\n    delay(${delayVal});\n  }\n}`;
        sText.innerText = "Success! Code Generated.";
    };
    reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
